{% extends "base.html" %}

{% block title %}My Events - SymbiHub{% endblock %}

{% block content %}
<!-- Debug Info -->
{% if debug_mode %}
<div class="bg-yellow-50 dark:bg-yellow-900 p-4 mb-4 rounded-lg">
    <h3 class="font-bold text-yellow-800 dark:text-yellow-200">Debug Info:</h3>
    <ul class="list-disc list-inside text-yellow-700 dark:text-yellow-300">
        <li>Created Events: {{ created_events|length }}</li>
        <li>Registered Events: {{ registered_events|length }}</li>
        <li>Current User: {{ session.get('username', 'Not logged in') }}</li>
    </ul>
</div>
{% endif %}
<div class="max-w-7xl mx-auto">

<!-- Local Modals (stateless) -->
{% if created_event %}
<div id="createdEventModalLocal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
        <div class="text-center mb-6">
            <i class="ph ph-check-circle text-6xl text-green-500"></i>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mt-4">Event Created</h3>
        </div>
        <p class="text-gray-600 dark:text-gray-300 text-center mb-4">Your event "{{ created_event.title }}" has been created.</p>
        <div class="flex justify-center space-x-4">
            <a href="{{ url_for('event_details', event_id=created_event.id) }}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">View Event</a>
            <button onclick="document.getElementById('createdEventModalLocal').classList.add('hidden')" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors">Close</button>
        </div>
    </div>
</div>
{% endif %}

{% if registration_success %}
<div id="registrationSuccessModalLocal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md w-full mx-4">
        <div class="text-center mb-6">
            <i class="ph ph-ticket text-6xl text-green-500"></i>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mt-4">Registration Successful</h3>
        </div>
        <p class="text-gray-600 dark:text-gray-300 text-center mb-4">You're registered for "{{ registration_success.title }}"</p>
        {% if registration_success.qr_image %}
        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg text-center mb-4">
            <img src="data:image/png;base64,{{ registration_success.qr_image }}" alt="QR" class="mx-auto mb-2" style="width:180px;height:180px;">
            <p class="text-xs font-mono text-gray-500 dark:text-gray-400">{{ registration_success.qr_code }}</p>
        </div>
        {% endif %}
        <div class="flex justify-center space-x-4">
            <button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">Print QR</button>
            <button onclick="document.getElementById('registrationSuccessModalLocal').classList.add('hidden')" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 transition-colors">Close</button>
        </div>
    </div>
</div>
{% endif %}


    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">My Events</h1>
        <p class="text-gray-600 dark:text-gray-400">Manage your created events and view your registrations</p>
    </div>

    <!-- Tabs -->
    <div class="mb-8">
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="-mb-px flex space-x-8">
                <button onclick="showTab('created')" id="created-tab" 
                        class="py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 dark:text-blue-400">
                    <i class="ph ph-plus-circle mr-2"></i>Created Events ({{ created_events|length }})
                </button>
                <button onclick="showTab('registered')" id="registered-tab" 
                        class="py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="ph ph-calendar-check mr-2"></i>Registered Events ({{ registered_events|length }})
                </button>
            </nav>
        </div>
    </div>

    <!-- Created Events Tab -->
    <div id="created-events" class="tab-content">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Events I Created</h2>
            <a href="{{ url_for('create_event') }}" 
               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                <i class="ph ph-plus mr-2"></i>
                Create New Event
            </a>
        </div>

        {% if created_events %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for event in created_events %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <!-- Event Cover Image -->
                {% if event.cover_image %}
                <div class="aspect-w-16 aspect-h-9">
                    <img src="{{ event.cover_image }}" alt="{{ event.title }}" 
                         class="w-full h-48 object-cover">
                </div>
                {% else %}
                <div class="w-full h-48 bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <i class="ph ph-calendar text-4xl text-white"></i>
                </div>
                {% endif %}
                
                <!-- Event Content -->
                <div class="p-6">
                    <!-- Event Status -->
                    <div class="flex items-center justify-between mb-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                   {% if event.status == 'upcoming' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                   {% elif event.status == 'ongoing' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                   {% elif event.status == 'completed' %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200
                                   {% else %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200{% endif %}">
                            {{ event.status.title() }}
                        </span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">
                            {{ event.event_date.strftime('%b %d, %Y') }}
                        </span>
                    </div>
                    
                    <!-- Event Title -->
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                        {{ event.title }}
                    </h3>
                    
                    <!-- Event Details -->
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="ph ph-users mr-2"></i>
                            <span>{{ event.registered_count }}/{{ event.max_participants }} registered</span>
                        </div>
                        {% if event.venue %}
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="ph ph-map-pin mr-2"></i>
                            <span>{{ event.venue }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-2">
                        <a href="{{ url_for('event_details', event_id=event.id) }}" 
                           class="flex-1 bg-blue-600 text-white text-center py-2 px-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
                            View
                        </a>
                        <a href="{{ url_for('update_event', event_id=event.id) }}" 
                           class="flex-1 bg-yellow-600 text-white text-center py-2 px-3 rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-colors text-sm">
                            Edit
                        </a>
                        <a href="{{ url_for('delete_event', event_id=event.id) }}" 
                           onclick="return confirm('Are you sure you want to delete this event?')"
                           class="flex-1 bg-red-600 text-white text-center py-2 px-3 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors text-sm">
                            Delete
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="ph ph-calendar-plus text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No events created yet</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Start by creating your first event!</p>
            <a href="{{ url_for('create_event') }}" 
               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                <i class="ph ph-plus mr-2"></i>
                Create Your First Event
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Registered Events Tab -->
    <div id="registered-events" class="tab-content hidden">
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Events I'm Registered For</h2>
        </div>

        {% if registered_events %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for event in registered_events %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <!-- Event Cover Image -->
                {% if event.cover_image %}
                <div class="aspect-w-16 aspect-h-9">
                    <img src="{{ event.cover_image }}" alt="{{ event.title }}" 
                         class="w-full h-48 object-cover">
                </div>
                {% else %}
                <div class="w-full h-48 bg-gradient-to-br from-green-500 to-blue-600 flex items-center justify-center">
                    <i class="ph ph-calendar-check text-4xl text-white"></i>
                </div>
                {% endif %}
                
                <!-- Event Content -->
                <div class="p-6">
                    <!-- Registration Status -->
                    <div class="flex items-center justify-between mb-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                   {% if event.payment_status == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                   {% else %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200{% endif %}">
                            {{ event.payment_status.title() }}
                        </span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">
                            {{ event.event_date.strftime('%b %d, %Y') }}
                        </span>
                    </div>
                    
                    <!-- Event Title -->
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                        {{ event.title }}
                    </h3>
                    
                    <!-- Event Details -->
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="ph ph-ticket mr-2"></i>
                            <span>{{ event.ticket_type }} Ticket</span>
                        </div>
                        {% if event.venue %}
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="ph ph-map-pin mr-2"></i>
                            <span>{{ event.venue }}</span>
                        </div>
                        {% endif %}
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="ph ph-calendar mr-2"></i>
                            <span>Registered: {{ event.registration_date.strftime('%b %d, %Y') }}</span>
                        </div>
                    </div>
                    
                    <!-- QR Code -->
                    {% if event.qr_code %}
                    <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-md">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">QR Code:</span>
                            <span class="text-sm font-mono text-gray-600 dark:text-gray-400">{{ event.qr_code }}</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-2">
                        <a href="{{ url_for('event_details', event_id=event.id) }}" 
                           class="flex-1 bg-blue-600 text-white text-center py-2 px-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
                            View Details
                        </a>
                        <button onclick="shareEvent({{ event.id }})" 
                                class="flex-1 bg-green-600 text-white py-2 px-3 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors text-sm">
                            Share
                        </button>
                        {% if event.registration_id %}
                        <a href="{{ url_for('download_certificate', registration_id=event.registration_id) }}" 
                           class="flex-1 bg-indigo-600 text-white text-center py-2 px-3 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors text-sm">
                            Get Certificate
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="ph ph-calendar-x text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No registered events</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Browse and register for events to see them here.</p>
            <a href="{{ url_for('events') }}" 
               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                <i class="ph ph-calendar mr-2"></i>
                Browse Events
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('[id$="-tab"]').forEach(tab => {
        tab.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
        tab.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-events').classList.remove('hidden');
    
    // Add active class to selected tab
    const activeTab = document.getElementById(tabName + '-tab');
    activeTab.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    activeTab.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
}

function shareEvent(eventId) {
    if (navigator.share) {
        navigator.share({
            title: 'Check out this event!',
            text: 'I found an interesting event on SymbiHub',
            url: window.location.origin + '/event/' + eventId
        });
    } else {
        // Fallback: copy to clipboard
        const url = window.location.origin + '/event/' + eventId;
        navigator.clipboard.writeText(url).then(() => {
            alert('Event link copied to clipboard!');
        });
    }
}

function showTab(tabName) {
    console.log('Switching to tab:', tabName);

    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        console.log('Found tab:', tab.id);
        tab.classList.add('hidden');
    });

    // Show selected tab
    const selectedTab = document.getElementById(tabName + '-events');
    console.log('Selected tab element:', selectedTab);
    if (selectedTab) {
        selectedTab.classList.remove('hidden');
    } else {
        console.error('Could not find tab element:', tabName + '-events');
    }

    // Update tab button styles
    document.querySelectorAll('button[id$="-tab"]').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
        button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    });

    const selectedButton = document.getElementById(tabName + '-tab');
    if (selectedButton) {
        selectedButton.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
        selectedButton.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
    }

    // Debug info (guard regex match in case tab label format changes)
    try {
        const createdText = document.getElementById('created-tab')?.textContent || '';
        const createdMatch = createdText.match(/\((\d+)\)/);
        console.log('Created events count: ' + (createdMatch ? createdMatch[1] : '0'));
    } catch (e) {
        console.log('Could not parse created events count');
    }
    console.log('Registered events tab visibility: ' + !document.getElementById('registered-events')?.classList.contains('hidden'));
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing tabs...');
    
    // Check if there's a target tab in URL hash
    const hash = window.location.hash.slice(1);
    if (hash === 'registered') {
        showTab('registered');
    }
    
    // Add click listeners to tab buttons
    document.querySelectorAll('button[onclick]').forEach(button => {
        const tabName = button.getAttribute('onclick').match(/'(.+?)'/)[1];
        button.onclick = function(e) {
            e.preventDefault();
            showTab(tabName);
        };
    });
    
    console.log('Tab initialization complete');
});
</script>
{% endblock %}
